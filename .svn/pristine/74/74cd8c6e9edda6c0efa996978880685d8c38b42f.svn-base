<?php
namespace Admin\Controller;
use Think\Controller;
use \Lib\Page;


/**
 * 事故查询
 */
class AccidentSearchLeaderController extends CommonController {
    /**
     * 列表页画面加载
     */
    public function index(){
        $this->assign('accident_type',get_custom_config('accident_type'));
        $this->display();
    }

    /**
     * 列表页表格
     */
    public function indexTable(){
        $map = array();
        $condition = get_condition();
        isset($condition['name']) && $map['name'] = array('LIKE','%'.$condition['name'].'%');
        isset($condition['idno']) && $map['idno'] = array('LIKE','%'.$condition['idno'].'%');
        isset($condition['car_no']) && $map['car_no'] = $condition['car_no'];
        $clientModel = M('CaseClient');
        $caseIds = $clientModel->field('group_concat(distinct case_id) as case_id')->where($map)->group('case_id')->select();
        if(!isset($condition['name']) && !isset($condition['idno']) && !isset($condition['car_no'])){
            $caseIds = M('Case')->field('group_concat(id) as case_id')->select();
        }
        $map1 = array();
        if (is_time($condition['start_time']) && is_time($condition['end_time'])) {
            $map1['CaseInfo.accident_time'] = array(array('egt', strtotime($condition['start_time'])), array('elt', strtotime($condition['end_time'])));
        } else if (is_time($condition['end_time'])) {
            $map1['CaseInfo.accident_time'] = array(array('elt', strtotime($condition['end_time'])));
        } else if (is_time($condition['start_time'])) {
            $map1['CaseInfo.accident_time'] = array(array('egt', strtotime($condition['start_time'])));
        }
        isset($condition['accident_type']) && $map1['accident_type'] = $condition['accident_type'];
        $map1['CaseInfo.id'] = array('in','-1,'.$caseIds[0]['case_id']);
        $map1['CaseInfo.cate'] = 0;
        $model = D('AccidentSearchLeaderView');
        $count = $model->where($map1)->count('DISTINCT CaseInfo.id');
        $page = new Page($count, 15);
        $list = $model->where($map1)->group('CaseInfo.id')->order('CaseInfo.create_time desc')->limit($page->firstrow . ',' . $page->rows)->select();
        foreach($list as $key => $val){
            //逃逸是否抓获
            $map = array();
            $map['case_id'] = $val['id'];
            $map['escape_catch_man_time'] = 0;
            $map['is_escape'] = 1;
            $result = M('CaseClient')->where($map)->select();
            if(count($result) > 0){
                $list[$key]['is_catch'] = 0;
            }else{
                $list[$key]['is_catch'] = 1;
            }
            // 案件状态
            $caseStatus = new \Lib\CaseStatus($val['id']);
            $list[$key]['case_status'] = $caseStatus->getStatus();
            //是否可以作废
            //受案登记信息
            $map = array();
            $map['case_id'] = $val['id'];
            $map['check_status'] = 0;
            $map['status'] = 1;
            $acceptInfo = M('CaseAccept')->where($map)->select();
            //检验鉴定信息
            $map = array();
            $map['case_id'] = $val['id'];
            $checkUpInfo = M('CaseCheckup')->where($map)->select();
            $map = array();
            $map['case_id'] = $val['id'];
            $map['case_checkup_id'] = $checkUpInfo['id'];
            $map['status'] = 0;
            $checkUpSubmitInfo = M('CaseCheckupReview')->where($map)->select();
            //事故认定、道路交通事故证明信息
            $map = array();
            $map['case_id'] = $val['id'];
            $map['check_status'] = 0;
            $map['is_submit'] = 1;
            $cognizanceInfo = M('CaseCognizance')->where($map)->select();
            //呈请中止信息
            $map = array();
            $map['case_id'] = $val['id'];
            $map['check_status'] = 0;
            $map['is_submit'] = 1;
            $cognizanceStopInfo = M('CaseCognizanceStop')->where($map)->select();
            //主表信息
            $map = array();
            $map['id'] = $val['id'];
            $map['is_over'] = 1;
            $CaseInfo = M('Case')->where($map)->select();
            if(count($cognizanceStopInfo) > 0 || count($cognizanceInfo) > 0){
                $list[$key]['forbiddenMsg'] = '事故认定正在审批,不能作废';
            }
            if(count($checkUpSubmitInfo) > 0){
                $list[$key]['forbiddenMsg'] = '检验鉴定正在审批,不能作废';
            }
            if(count($acceptInfo) > 0){
                $list[$key]['forbiddenMsg'] = '受案登记正在审批,不能作废';
            }
            if(count($CaseInfo) > 0){
                $list[$key]['forbiddenMsg'] = '该事故已经出具事故认定,不能作废';
            }
            //当事人信息
            $map = array();
            $map['case_id'] = $val['id'];
            $map['status'] = 0;
            $clientDetainList = M('CaseClientDetain')->where($map)->select();
            if(count($clientDetainList) > 0){
                $list[$key]['forbiddenMsg'] = '当事人物品被扣押,不能作废';
            }
            //被作废的检验鉴定记录
            $map = array();
            $map['case_id'] = $val['id'];
            $map['is_cancel'] = 1;
            $checkUp = M('CaseCheckup')->where($map)->select();
            if(count($checkUpInfo) > 0){
                if(count($checkUp) > 0){
                    $list[$key]['forbiddenMsg'] = '检验鉴定未作废,不能作废';
                }
            }
            //是否可以退回
            //没有事故认定不能退回
            $map = array();
            $map['case_id'] = $val['id'];
            $map['is_back'] = 0;
            $cognizanceInfo = M('CaseCognizance')->where($map)->select();
            if(count($cognizanceInfo) == 0){
                $list[$key]['backMsg'] = '没有事故认定，不能退回';
            }
            //未制作不能退回
            $map = array();
            $map['case_id'] = $val['id'];
            $makeCognizanceInfo = M('CaseCognizance')->where($map)->select();
            if($makeCognizanceInfo[0]['cognizance_type'] == '1'){
                if($makeCognizanceInfo[0]['is_make'] == '0'){
                    $list[$key]['backMsg'] = '事故认定未制作，不能退回';
                }
            }
            //有复核申请，已终止时可以退回
            $map = array();
            $map['case_id'] = $val['id'];
            $map['is_over'] = 0;
            $reviewInfo = M('CaseReview')->where($map)->select();
            if(count($reviewInfo) > 0){
                $list[$key]['backMsg'] = '该事故认定已申请复核，不能退回';
            }
            $map = array();
            $map['case_id'] = $val['id'];
            $cognizanceList = M('CaseCognizance')->where($map)->order('id desc')->limit(1)->select();
            if($cognizanceList[0]['is_back'] == 1){
                $list[$key]['is_back'] = 1;
            }else{
                $list[$key]['is_back'] = 0;
            }
        }
        $this->assign('list', $list);
        // 分页信息
        $pageInfo = array(
            'totalrows' => $count,
            'totalpage' => $page->totalpages,
            'nowpage' => $page->nowpage,
        );
        $this->assign('accident_type',get_custom_config('accident_type'));
        $this->assign('page', $pageInfo);
        $this->display('AccidentSearchLeader/index/table');
    }
    /**
     * 作废
     */
    public function forbid(){
        $map = array();
        $map['is_del'] = 1;
        $map['del_reason'] = I('post.del_reason');
        $map['id'] = I('post.id','','int');
        $rs = D('Case')->save($map);
        if($rs === false){
            $this->error('操作失败');
        }else{
            $this->success('操作成功');
        }
    }

    /**
     * 退回
     */
    public function back(){
        $para = array();
        $para['case_id'] = I('post.id','','int');
        $para['is_back'] = 0;
		$model = M('CaseCognizance');
		$model->startTrans();
        $cognizanceInfo = M('CaseCognizance')->where($para)->find();
        $map = array();
        $map['id'] = $cognizanceInfo['id'];
        $map['is_back'] = 1;
        $map['is_make'] = 0;
        $map["back_time"] = time();
        $map['back_user_id'] = $this->my['id'];
        $map['back_reason'] = I('post.back_reason');
        $rs = D('CaseCognizance')->save($map);
        if($rs === false){
			$model->rollback();
            $this->error('操作失败1');
        }
        $map = array();
        $map['is_over'] = 0;
        $map['cognizance_send_status'] = 0;
        $map['cognizance_check_status'] = 4;
        $map['cognizance_status'] = 0;
        $map['update_time'] = time();
        $map['update_user_id'] = $this->my['id'];
        $map['id'] = I('post.id','','int');
        $rs = D('Case')->save($map);

        if($rs === false){
            $model->rollback();
            $this->error('操作失败2');
        }

        $map = array();
        $map['case_id'] = I('post.id','','int');
        $map['cate'] = array('in',array(18,19,22));
        $map['ext_ida'] = $cognizanceInfo['case_cognizance_id'];
        $para = array();
        $para['is_document'] = 0;
        $para['update_user_id'] = $this->my['id'];
        $para['update_time'] = time();
        $rs = M('CasePhoto')->where($map)->save($para);
        if($rs === false){
			$model->rollback();
            $this->error('操作失败3');
        }
        $model->commit();
        $this->success('操作成功');
    }
}